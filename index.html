<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trợ Lý Ảo Nhựa Tiền Phong</title>
    <!-- Tải Tailwind CSS để tạo giao diện nhanh chóng -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tải Font Inter từ Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .chat-container {
            height: calc(100vh - 4rem);
            max-width: 800px;
        }
        .chat-messages {
            overflow-y: auto;
        }
        .user-message {
            background-color: #d1fae5;
        }
        .bot-message {
            background-color: #e5e7eb;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

<div class="chat-container bg-white shadow-xl rounded-2xl flex flex-col w-full p-6">
    <!-- Tiêu đề Chatbot -->
    <div class="text-center font-bold text-2xl text-gray-800 pb-4 border-b-2 border-gray-200">
        Trợ lý ảo hỗ trợ kỹ thuật
    </div>

    <!-- Khu vực hiển thị tin nhắn -->
    <div id="chat-messages" class="chat-messages flex-1 mt-4 space-y-4">
        <!-- Tin nhắn sẽ được thêm vào đây bằng JavaScript -->
    </div>

    <!-- Khu vực nhập liệu -->
    <div class="mt-6">
        <div id="loading-indicator" class="hidden text-center text-sm text-gray-500 mb-2">
            Đang soạn câu trả lời...
        </div>
        <form id="chat-form" class="flex items-center">
            <input
                type="text"
                id="user-input"
                class="flex-1 p-4 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-500 transition-all"
                placeholder="Nhập câu hỏi của bạn..."
            >
            <button
                type="submit"
                class="ml-4 p-4 bg-emerald-600 text-white rounded-xl font-semibold hover:bg-emerald-700 transition-colors"
            >
                Gửi
            </button>
        </form>
        <div id="error-message" class="hidden text-sm text-red-500 mt-2"></div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- 1. CẤU HÌNH API VÀ MÔ HÌNH ---
        // LƯU Ý QUAN TRỌNG:
        // Đặt API Key thành chuỗi rỗng để nó được cung cấp tự động bởi môi trường.
        const API_KEY = "AIzaSyCDFfsNYwqPQ4_8SGchEWX6mxTh1PlIQ9g";
        
        // Mô hình bạn muốn sử dụng. `gemini-2.5-flash-preview-05-20` là một lựa chọn mạnh mẽ.
        const MODEL_NAME = "gemini-2.5-flash-preview-05-20"; 

        // --- 2. LỊCH SỬ TRÒ CHUYỆN (CONTEXT) ---
        // Đây là nơi bạn định nghĩa vai trò của chatbot.
        // NHẤT ĐỊNH PHẢI SAO CHÉP CHÍNH XÁC "System Instructions" từ Google AI Studio vào đây.
        // Điều này đảm bảo chatbot của bạn hoạt động đúng như mong muốn.
        const chatHistory = [
            {
                "role": "user",
                "parts": [{ "text": "Bạn là Trợ lý ảo hỗ trợ khách hàng của Nhựa Tiền Phong.\nNhiệm vụ của bạn là hỗ trợ trả lời câu hỏi kỹ thuật và sự cố sản phẩm dựa trên các tài liệu đã được import vào hệ thống.\n\nNguyên tắc hoạt động:\n\nNguồn dữ liệu:\n\nChỉ trả lời dựa trên dữ liệu có trong các file đã được import.\n\nKhông được suy đoán hoặc cung cấp thông tin ngoài phạm vi tài liệu.\n\nNếu tìm thấy câu trả lời trong dữ liệu:\n\nTrình bày câu trả lời rõ ràng, dễ hiểu, thân thiện.\n\nGiải thích ngắn gọn nhưng đầy đủ.\n\nCó thể gợi ý bước tiếp theo để Khách hàng dễ xử lý.\n\nNếu không tìm thấy câu trả lời trong dữ liệu:\n\nXin lỗi Khách hàng vì chưa có thông tin trong tài liệu.\n\nHỏi thêm thông tin từ Khách hàng:\n\nHọ tên\n\nSố điện thoại/email\n\nMã sản phẩm hoặc mô tả sự cố\n\nSau đó đưa thông tin liên hệ kỹ thuật viên để Khách hàng có thể chủ động liên hệ:\n\nNhóm HTKH - Ban CNCL - Công Ty CP Nhựa TNTP\n\nSĐT: xxx-xxx-xxxx\n\nEmail: support@nhuatienphong.vn\n\nPhong cách giao tiếp:\n\nThân thiện, chuyên nghiệp, hỗ trợ nhanh chóng.\n\nTránh dùng ngôn từ quá kỹ thuật gây khó hiểu cho khách hàng phổ thông." }]
            },
            {
                "role": "model",
                "parts": [{ "text": "Tôi là Trợ lý ảo hỗ trợ Khách hàng của Nhựa Tiền Phong, sẵn sàng hỗ trợ Quý khách giải đáp các thắc mắc kỹ thuật và sự cố sản phẩm của Công ty.\n\nXin mời Quý khách đặt câu hỏi ạ." }]
            }
        ];

        // --- 3. CÁC BIẾN VÀ HÀM QUẢN LÝ GIAO DIỆN ---
        const chatMessages = document.getElementById('chat-messages');
        const chatForm = document.getElementById('chat-form');
        const userInput = document.getElementById('user-input');
        const loadingIndicator = document.getElementById('loading-indicator');
        const errorMessage = document.getElementById('error-message');

        /**
         * Thêm tin nhắn vào giao diện người dùng.
         * @param {string} text Nội dung tin nhắn.
         * @param {string} sender Người gửi ('user' hoặc 'bot').
         */
        function addMessage(text, sender) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('p-4', 'rounded-xl', 'max-w-[85%]', 'whitespace-pre-wrap');
            if (sender === 'user') {
                messageElement.classList.add('user-message', 'ml-auto', 'rounded-br-none', 'text-gray-800');
            } else {
                messageElement.classList.add('bot-message', 'rounded-bl-none', 'text-gray-700');
            }
            messageElement.textContent = text;
            chatMessages.appendChild(messageElement);
            // Cuộn xuống cuối khung chat
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // --- 4. GỌI API GEMINI VÀ XỬ LÝ PHẢN HỒI ---
        /**
         * Gửi yêu cầu đến Gemini API và nhận câu trả lời.
         * @param {string} message Tin nhắn của người dùng.
         */
        async function sendMessage(message) {
            // Thêm tin nhắn của người dùng vào lịch sử trò chuyện
            chatHistory.push({ "role": "user", "parts": [{ "text": message }] });
            addMessage(message, 'user');
            userInput.value = '';
            loadingIndicator.classList.remove('hidden');
            errorMessage.classList.add('hidden');

            const payload = {
                contents: chatHistory
            };

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${API_KEY}`;
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`API returned status ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                
                // Kiểm tra và lấy câu trả lời từ API
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const botResponse = result.candidates[0].content.parts[0].text;
                    // Thêm câu trả lời của bot vào lịch sử và giao diện
                    chatHistory.push({ "role": "model", "parts": [{ "text": botResponse }] });
                    addMessage(botResponse, 'bot');
                } else {
                    throw new Error("Không nhận được câu trả lời từ mô hình.");
                }

            } catch (error) {
                console.error('Error during API call:', error);
                errorMessage.textContent = 'Xin lỗi, đã xảy ra lỗi trong quá trình xử lý. Vui lòng thử lại sau.';
                errorMessage.classList.remove('hidden');
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        }

        // --- 5. LẮNG NGHE SỰ KIỆN GỬI TIN NHẮN ---
        chatForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const message = userInput.value.trim();
            if (message) {
                sendMessage(message);
            }
        });
        
        // Hiển thị tin nhắn chào mừng ban đầu từ lịch sử chat
        addMessage("Dạ vâng, tôi đã hiểu rõ vai trò của mình.\n\nTôi là Trợ lý ảo của Nhựa Tiền Phong, sẵn sàng hỗ trợ Quý khách giải đáp các thắc mắc kỹ thuật và sự cố sản phẩm dựa trên tài liệu kỹ thuật của công ty.\n\nXin mời Quý khách đặt câu hỏi ạ.", 'bot');
    });
</script>

</body>
</html>


